## Hướng dẫn cấu hình graylog thu thập log bằng syslog.

Nối tiếp bài cài đặt graylog server, trong hướng dẫn này sẽ thực hiện cấu hình syslog ở phía client để graylog server có thể thu thập log. 

Đây chỉ là một trong những `input` mà Graylog server hỗ trợ nhận hoặc thu thập log.

## 1. Mô hình

Mô hình LAB graylog được triển khai theo hình dưới.

![Mo_hinh_Lab_Graylog](https://image.prntscr.com/image/0h11iWIxSw6JOSDaAnO5Ag.png)

## 2. IP Planning

- Các IP được sử dụng trong mô hình LAB như sau:

![IP_Planning_Lab_Graylog](https://image.prntscr.com/image/knuD9-1_T-GLwBycIbFR8A.png)

## 3. Cài đặt

Trong hướng dẫn này, ta sẽ thực hiện cài đặt syslog trên client, sau đó khai báo trên graylog server để có thể nhận log.

### 3.1. Thiết lập môi trường

-  Thực hiện update và cài đặt gói bổ trợ.
    ```
    yum update -y
    yum install -y epel-release 
    yum install -y git byobu wget vim pwgen
    ```

- Thiết lập IP
    ```
    echo "Setup IP  eth0"
    nmcli con modify eth0 ipv4.addresses 192.168.56.12/24
    nmcli con modify eth0 ipv4.gateway 192.168.56.1
    nmcli con modify eth0 ipv4.dns 8.8.8.8
    nmcli con modify eth0 ipv4.method manual
    nmcli con modify eth0 connection.autoconnect yes
    ```

- Thiết lập hostname
    ```
    hostnamectl set-hostname client01
    echo  "127.0.0.1 localhost client01" > /etc/hosts
    echo  "192.168.56.11 graylogserver" >> /etc/hosts
    echo  "192.168.56.12 client01" >> /etc/hosts
    ```

- Cấu hình các chế độ mạng và firewall
    ```
    sudo systemctl disable firewalld
    sudo systemctl stop firewalld
    sudo systemctl disable NetworkManager
    sudo systemctl stop NetworkManager
    sudo systemctl enable network
    sudo systemctl start network

    sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux
    sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
    ```

- Khởi động lại OS
    ```
    reboot
    ```
### 3.2. Cài đặt NTP

- Sử dụng chrony để khai báo cấu hình NTP cho máy graylog server. Đây là một yêu cầu khá quan trọng khi cấu hình hệ thống log tập trung bởi vì thời gian cần đảm bảo chuẩn xác để nhận log được đúng.
    ```
    yum install -y chrony
    ```

- Khởi động và kích hoạt chrony
    ```
    systemctl start chronyd

    systemctl enable chronyd
    ```

- Kiểm tra xem chrony đã được đồng bộ hay chưa.
    ```
    chronyc sources
    ```

- Kết quả ta thấy xuất hiện dấu `^*` ở đầu dòng IP của máy chủ NTP server là ok.
    ```
    210 Number of sources = 4
    MS Name/IP address         Stratum Poll Reach LastRx Last sample
    ===============================================================================
    ^* 162.159.200.123               3   6    17     8  -3908us[-5035us] +/-   66ms
    ^+ 162.159.200.1                 3   6    17     9  -6079us[-7206us] +/-   67ms
    ^+ no-ptr.123host.vn             3   6    17     8  +4295us[+3167us] +/-  164ms
    ^- mail.khangthong.vn            2   6    17     8    -64ms[  -65ms] +/-  207ms
    [root@graylogserver ~]# timedatectl
        Local time: Sun 2019-12-01 23:36:41 +07
    Universal time: Sun 2019-12-01 16:36:41 UTC
            RTC time: Sun 2019-12-01 16:36:41
        Time zone: Asia/Ho_Chi_Minh (+07, +0700)
        NTP enabled: yes
    NTP synchronized: yes
    RTC in local TZ: no
        DST active: n/a
    ```

- Kiểm tra lại bằng lệnh `timedatectl`, ta thu được kết quả thời gian đã được đồng bộ như bên dưới là OK.

![chronyd](https://image.prntscr.com/image/ENrPD2P8SsmyhcQLpz4djA.png)

Nếu bạn sử dụng máy chủ NTP server nội bộ, hãy tìm thêm tài liệu để cấu hình chrony cho phù hợp. Trong hướng dẫn này sẽ sử dụng NTP server ở mạng bên ngoài.
